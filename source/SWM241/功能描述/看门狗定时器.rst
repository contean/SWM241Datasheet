.. vim: syntax=rst

看门狗定时器（WDT）
-----------------------

概述
~~

SWM241系列所有型号WDT操作均相同。使用前需使能对应WDT模块时钟。

看门狗定时器（WDT）主要用于控制程序流程正确，在程序流长时间未按既定流程执行指定程序的情况下产生中断或复位芯片。

特性
~~

-  产生计数器溢出复位信号，复位信号使能可配

-  具有16位计数位宽，可配置灵活、宽范围的溢出周期

-  具有中断功能

-  时钟源为32K

模块结构框图
~~~~~~

|看门狗定时器002|

图 6‑15 WDT模块结构框图

功能描述
~~~~

配置方式
^^^^

看门狗定时器（WDT）主要用于控制程序流程正确，在程序流程时间未按既定流程执行指定程序的情况下产生中断或复位芯片。

看门狗发生中断及复位与计数值之间的关系示意图如图 6‑16所示：

|看门狗定时器003|

图 6‑16 门狗发生中断及复位与计数值之间的关系示意图

配置方式如下：

-  配置复位值寄存器RSTVAL，设置复位值，WDT为递增计数

-  配置控制寄存器CR中RSTEN位，设置以系统时钟为单位递增时产生中断或产生复位

-  将控制寄存器CR中EN位置1，使能WDT模块

-  程序执行过程中通过向FEED寄存器写入0x55喂狗，重启计数

-  若当VALUE寄存器加至RSTVAL，依然未执行喂狗操作，则根据CR寄存器设置，产生中断或复位信号

工作示意图如图 6‑17所示：

|看门狗定时器004|

图 6‑17 WDT工作示意图

控制寄存器CR中RSTEN位配置为复位使能时，使能后波形如图 6‑18所示:

|看门狗定时器005|

图 6‑18 WDT配置为RESET模式波形图

控制寄存器CR中RSTEN位配置为复位失能时，使能后波形如图 6‑19所示，中断产生后，通过IF寄存器进行清除。

|看门狗定时器006|

图 6‑19 WDT配置为中断模式波形图

中断配置与清除
^^^^^^^

可通过配置WDT控制寄存器CR设置以系统时钟为单位递增时产生中断，并使能中断，启动WDT，当VALUE寄存器加至RSTVAL，依然未执行喂狗操作时，中断标志寄存器IF位置1。如需清除此标志，需在标志位中写1清零（R/W1C），否则中断在开启状态下会一直进入。

寄存器映射
~~~~~

下表列出了WDT模块的相关寄存器，所列偏移量为寄存器相对于WDT模块基址的16进制增量：

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 名称   |
     - | 偏移 |
     - |
       |
        |
        |
     - |

        |
        |
     - 描述                       | | | |

   * - WDTBASE：0 |x400A0800
     - |
     -
     -
     -

   * - RSTVAL
     - 0x00
     -
     - 0x 0FFFF
     - WDT复位值寄存器            |

   * - INTVAL
     - 0x04
     -
     - 0x 0FFFF
     - WDT中断值寄存器            |

   * - CR
     - 0x08
     -
     - 0x 00000
     - WDT控制寄存器              |

   * - IF
     - 0x0C
     -
     - 0x 00000
     - WDT中断状态寄存器          |

   * - FEED
     - 0x10
     -
     - 0x 00000
     - WDT重启计数器寄存器        |


寄存器描述
~~~~~

WDT复位值寄存器RSTVAL
^^^^^^^^^^^^^^^

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 寄存器 |
     - | 偏移 |
     - |
       |
         |
     - 复位值 |    描 | |
     - |
            |
              |

   * - RSTVAL
     - 0x00
     -
     - 0 00FFFF
     - WDT 复位值寄存器           |


.. list-table::
   :widths: 12 12 12 12 12 12 12 12
   :header-rows: 0


   * - 31
     - 30
     - 29
     - 28
     - 27
     - 26
     - 25
     - 24

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 23
     - 22
     - 21
     - 20
     - 19
     - 18
     - 17
     - 16

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 15
     - 14
     - 13
     - 12
     - 11
     - 10
     - 9
     - 8

   * - RSTVAL
     -
     -
     -
     -
     -
     -
     -

   * - 7
     - 6
     - 5
     - 4
     - 3
     - 2
     - 1
     - 0

   * - RSTVAL
     -
     -
     -
     -
     -
     -
     -


.. list-table::
   :widths: 33 33 33
   :header-rows: 0


   * - 位域 |
     - 名称     | |
     - 描述                                        | |

   * - 31:16
     - -
     - -

   * - 15:0
     - RSTVAL
     - WDT计数器的复位计数初始值。                 |


       DT计数值计数到该寄存器设置值时，产生复位。 |

       使能后配置无效                              |


WDT中断值寄存器INTVAL
^^^^^^^^^^^^^^^

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 寄存器 |
     - | 偏移 |
     - |
       |
         |
     - 复位值 |    描 | |
     - |
            |
              |

   * - INTVAL
     - 0x04
     -
     - 0 00FFFF
     - WDT中断值寄存器            |


.. list-table::
   :widths: 12 12 12 12 12 12 12 12
   :header-rows: 0


   * - 31
     - 30
     - 29
     - 28
     - 27
     - 26
     - 25
     - 24

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 23
     - 22
     - 21
     - 20
     - 19
     - 18
     - 17
     - 16

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 15
     - 14
     - 13
     - 12
     - 11
     - 10
     - 9
     - 8

   * - INTVAL
     -
     -
     -
     -
     -
     -
     -

   * - 7
     - 6
     - 5
     - 4
     - 3
     - 2
     - 1
     - 0

   * - INTVAL
     -
     -
     -
     -
     -
     -
     -


.. list-table::
   :widths: 33 33 33
   :header-rows: 0


   * - 位域 |
     - 名称     | |
     - 描述                                        | |

   * - 31:16
     - -
     - -

   * - 15:0
     - INTVAL
     - WDT计数器中断目标值                         |

       当W                                         | 数值递增计数到该寄存器设置值时，产生中断； |

       产生中断后，若未设置复位值则重              | 计数，若设置复位值，则继续计数直至复位；  |

       当中断与复位同时                            | ，INTVAL需要小于RSTVAL，产生中断后，若未 | 狗操作，则计数器继续计数，直至产生复位； |

       使能后配置无效；                            |

       当CR寄存器WINEN位为1                        | 未发生中断时喂狗，则直接发生看门狗复位。 |

       当CR寄存                                    | NEN位为0时，发生看门狗复位跟喂狗没有关系； |


WDT控制寄存器CR
^^^^^^^^^^

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 寄存器 |
     - | 偏移 |
     - |
       |
         |
     - 复位值 |    描 | |
     - |
            |
              |

   * - CR
     - 0x08
     -
     - 0 000000
     - WDT控制寄存器              |


.. list-table::
   :widths: 12 12 12 12 12 12 12 12
   :header-rows: 0


   * - 31
     - 30
     - 29
     - 28
     - 27
     - 26
     - 25
     - 24

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 23
     - 22
     - 21
     - 20
     - 19
     - 18
     - 17
     - 16

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 15
     - 14
     - 13
     - 12
     - 11
     - 10
     - 9
     - 8

   * - -
     -
     -
     -
     - CLKDIV
     -
     -
     -

   * - 7
     - 6
     - 5
     - 4
     - 3
     - 2
     - 1
     - 0

   * - -
     -
     -
     -
     - WINEN
     - INTEN
     - RSTEN
     - EN


.. list-table::
   :widths: 33 33 33
   :header-rows: 0


   * - 位域 |
     - 名称     | |
     - 描述                                        | |

   * - 31:12
     - -
     - -

   * - 11:8
     - CLKDIV
     - 看门狗计数时钟预分频寄存器                  |

       0000：2                                     |

       0001：4                                     |

       0010：8                                     |

       0011：16                                    |

       0100：32                                    |

       0101：64                                    |

       0110：128                                   |

       0111：256                                   |

       1000：512                                   |

       1001：1024                                  |

       1010：2048                                  |

       1011：4096                                  |

       1100：8192                                  |

       1101：16384                                 |

       1110：32768                                 |

       1111：65536                                 |

   * - 7:4
     - -
     - -

   * - 3
     - WINEN
     - WDT窗口功能使能                             |

       1：使能窗口功能                             |

       0：禁止窗口功能                             |

   * - 2
     - INTEN
     - WDT中断输出使能位                           |

       1：使能中断                                 |

       0：禁止中断                                 |

   * - 1
     - RSTEN
     - WDT复位输出使能位                           |

       1：使能复位                                 |

       0：禁止复位                                 |

   * - 0
     - EN
     - WDT启动位                                   |

       1：启动WDT计数                              |

       0：停止计数                                 |


WDT中断状态寄存器IF
^^^^^^^^^^^^

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 寄存器 |
     - | 偏移 |
     - |
       |
         |
     - 复位值 |    描 | |
     - |
            |
              |

   * - IF
     - 0x0C
     -
     - 0 000000
     - WDT中断状态寄存器          |


.. list-table::
   :widths: 12 12 12 12 12 12 12 12
   :header-rows: 0


   * - 31
     - 30
     - 29
     - 28
     - 27
     - 26
     - 25
     - 24

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 23
     - 22
     - 21
     - 20
     - 19
     - 18
     - 17
     - 16

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 15
     - 14
     - 13
     - 12
     - 11
     - 10
     - 9
     - 8

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 7
     - 6
     - 5
     - 4
     - 3
     - 2
     - 1
     - 0

   * - -
     -
     -
     -
     -
     -
     -
     - IF


.. list-table::
   :widths: 33 33 33
   :header-rows: 0


   * - 位域 |
     - 名称     | |
     - 描述                                        | |

   * - 31:1
     - -
     - -

   * - 0
     - IF
     - WDT中断位，高有效，R/W1C                    |

       硬件置位，写1清零                           |


WDT重启寄存器FEED
^^^^^^^^^^^^

.. list-table::
   :widths: 20 20 20 20 20
   :header-rows: 0


   * - 寄存器 |
     - | 偏移 |
     - |
       |
         |
     - 复位值 |    描 | |
     - |
            |
              |

   * - FEED
     - 0x10
     -
     - 0 000000
     - WDT重启计数器寄存器        |


.. list-table::
   :widths: 12 12 12 12 12 12 12 12
   :header-rows: 0


   * - 31
     - 30
     - 29
     - 28
     - 27
     - 26
     - 25
     - 24

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 23
     - 22
     - 21
     - 20
     - 19
     - 18
     - 17
     - 16

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 15
     - 14
     - 13
     - 12
     - 11
     - 10
     - 9
     - 8

   * - -
     -
     -
     -
     -
     -
     -
     -

   * - 7
     - 6
     - 5
     - 4
     - 3
     - 2
     - 1
     - 0

   * - FEED
     -
     -
     -
     -
     -
     -
     -


.. list-table::
   :widths: 33 33 33
   :header-rows: 0


   * - 位域 |
     - 名称     | |
     - 描述                                        | |

   * - 31:8
     - -
     - -

   * - 7:0
     - FEED
     - 看门狗重启计数器寄存器                      |

       当向该                                      | 写入0x55后会重启看门狗计数器（喂狗操作） |


.. |看门狗定时器002| image:: media\看门狗定时器002.emf
.. |看门狗定时器003| image:: media\看门狗定时器003.emf
.. |看门狗定时器004| image:: media\看门狗定时器004.emf
.. |看门狗定时器005| image:: media\看门狗定时器005.emf
.. |看门狗定时器006| image:: media\看门狗定时器006.emf
